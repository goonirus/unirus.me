<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é£è¡Œæ£‹ v8ï¼ˆç¦»çº¿Canvasï¼š52æ ¼ã€èµ·é£åŒºå¯¹é½èµ·ç‚¹ã€é—¨å£åŒè‰²ã€åŸºåœ°åœ¨è§’è½ï¼‰</title>
<style>
  html, body { margin:0; padding:0; background:#0f1226; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  #wrap { display:flex; flex-direction:column; align-items:center; gap:10px; padding:14px; }
  .panel { color:#e8ebff; max-width:820px; width:100%; }
  .row { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .btn { background:#3940ff; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .hint { color:#aab1ff; font-size:14px; line-height:1.4; text-align:center; }
  .badge { padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .p0 { background:#ff4d6d; color:#fff; }
  .p1 { background:#ffd166; color:#001; }
  .p2 { background:#6ab0ff; color:#001; }
  .p3 { background:#18c0a6; color:#001; }
  canvas { background:#0b0f28; box-shadow: 0 0 0 1px #233; border-radius: 6px; }
  #err{display:none;color:#ffb4c1;background:#2b2230;padding:8px 12px;border-radius:8px;max-width:820px}
</style>

<style>
#rollBtn[data-pos="dynamic"]{
  position:fixed;              /* ç›¸å¯¹è§†å£å®šä½ï¼Œé¿å…éšæ»šåŠ¨é”™ä½ */
  z-index:9999;
  transform:scale(2);
  transform-origin: left bottom;
  box-shadow:0 10px 28px rgba(0,0,0,.18);
}
</style>


<style>
#aiStatus{
  position:fixed; z-index:9998;
  background:rgba(17,24,39,.85); color:#e5e7eb;
  border:1px solid rgba(255,255,255,.08); border-radius:10px;
  padding:10px 12px; backdrop-filter: blur(4px);
  min-width: 160px;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  font:13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
#aiStatus .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:2px 0; }
#aiStatus .who{ display:flex; align-items:center; gap:8px; }
#aiStatus .dot{ width:10px; height:10px; border-radius:50%; }
#aiStatus .p0{ background:#d63b3b } /* çº¢ */
#aiStatus .p1{ background:#f6b10a } /* é»„ */
#aiStatus .p2{ background:#4d77c9 } /* è“ */
#aiStatus .p3{ background:#5aa654 } /* ç»¿ */
#aiStatus .tag{ opacity:.9; }
</style>
<div id="aiStatus" style="display:none">
  <div class="row"><div class="who"><span class="dot p0"></span><span>çº¢æ–¹</span></div><span class="tag" id="aiTag0">-</span></div>
  <div class="row"><div class="who"><span class="dot p1"></span><span>é»„æ–¹</span></div><span class="tag" id="aiTag1">-</span></div>
  <div class="row"><div class="who"><span class="dot p2"></span><span>è“æ–¹</span></div><span class="tag" id="aiTag2">-</span></div>
  <div class="row"><div class="who"><span class="dot p3"></span><span>ç»¿æ–¹</span></div><span class="tag" id="aiTag3">-</span></div>
</div>


<script>
// Ensure S.ai exists early
(function(){
  function ensure(){ try{ if(window.S && !Array.isArray(S.ai)) S.ai=[false,false,false,false]; }catch(e){} }
  ensure(); setTimeout(ensure, 0); window.addEventListener('load', ensure);
})();
</script>

</head>
<body>

<!-- Start Screen Overlay -->
<style>
#startScreen{
  position:fixed; inset:0; background:linear-gradient(180deg,#0f172a,#111827);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:#fff; z-index:10000;
}
#startScreen h1{ font:700 28px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0 0 12px;}
#startScreen p{ font:400 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0 0 20px; opacity:.9; text-align:center; max-width:520px; padding:0 16px;}
#startBtn{
  appearance:none; border:0; border-radius:12px; padding:12px 18px; cursor:pointer;
  background:#22c55e; color:#0a0a0a; font:600 15px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
  box-shadow:0 8px 24px rgba(34,197,94,.35);
}
#startBtn:hover{ filter:brightness(1.05); }
#startHint{ margin-top:10px; font:500 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; opacity:.75;}
</style>
<div id="startScreen">
  <h1>ç–¯ç‹‚é£è¡Œæ£‹</h1>
  <p>æ·éª°å‰å…ˆè¿›å…¥æ¸¸æˆï¼šè½®åˆ°æŸæ–¹æ—¶ï¼Œå¦‚æ— æ£‹å¯èµ°å°†è‡ªåŠ¨è·³è¿‡ï¼›æœ‰æ£‹å¯èµ°åˆ™ç­‰å¾…ç‚¹å‡»æ£‹å­ï¼Œèµ°å®Œè‡ªåŠ¨ç»“æŸï¼ˆæ·å‡º 6 å¯å†æ·ï¼‰ã€‚</p>
  <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
  <div style="display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:12px;margin-top:16px">
    <label style="display:flex;align-items:center;gap:8px">
      <span class="badge p0">çº¢æ–¹</span>
      <select id="aiRed"><option value="human">äººç±»</option><option value="ai">AI</option></select>
    </label>
    <label style="display:flex;align-items:center;gap:8px">
      <span class="badge p1">é»„æ–¹</span>
      <select id="aiYellow"><option value="human">äººç±»</option><option value="ai">AI</option></select>
    </label>
    <label style="display:flex;align-items:center;gap:8px">
      <span class="badge p2">è“æ–¹</span>
      <select id="aiBlue"><option value="human">äººç±»</option><option value="ai">AI</option></select>
    </label>
    <label style="display:flex;align-items:center;gap:8px">
      <span class="badge p3">ç»¿æ–¹</span>
      <select id="aiGreen"><option value="human">äººç±»</option><option value="ai">AI</option></select>
    </label>
  </div>
  <div id="startHint">Start / Enter ä¹Ÿå¯ä»¥å¼€å§‹</div>
</div>

  <div id="wrap">
    <div class="panel row">
      <button id="rollBtn" class="btn" data-pos="dynamic">ğŸ² æ·éª°</button>
      <button id="endBtn" class="btn" style="display:none" style="display:none" disabled>â­ï¸ ç»“æŸå›åˆ</button>
      <span id="turnTag" class="badge p0">å½“å‰ï¼šçº¢æ–¹</span>
      <span id="diceTag" class="badge" style="background:#1f233e;color:#cfe0ff">éª°å­ï¼š-</span>
    </div>
    <div id="msg" class="panel hint">è§„åˆ™ï¼š52æ ¼æ•´åœˆè¿è‰²ä¸”é—¨å£åŒè‰²ï¼›æ·6è¿›èµ·é£åŒºâ†’å†èµ°1æ ¼å…¥å¤–åœˆèµ·ç‚¹ï¼ˆé—¨å£é¡ºæ—¶é’ˆä¸‰æ ¼ä¸”èµ·é£åŒºé¡ºæ—¶é’ˆå¯¹é½ï¼‰ï¼›è½åˆ°è‡ªè‰²æ ¼è·³+4ï¼ˆä»…ä¸€æ¬¡ï¼‰ï¼›åŒæ ¼åƒå­ï¼›æ— å®‰å…¨æ ¼ï¼›6æ ¼ç»ˆç‚¹ï¼Œéœ€ç²¾ç¡®ï¼›åŸºåœ°åœ¨å››è§’ã€‚</div>
    <canvas id="board" width="800" height="800"></canvas>
    <div id="err"></div>
  </div>

<script>
// é”™è¯¯å…œåº•
window.addEventListener('error', (e)=>{
  const el=document.getElementById('err'); if(!el) return;
  el.style.display='block';
  el.textContent = 'é”™è¯¯ï¼š'+ e.message + (e.filename? (' @'+e.filename):'') + (e.lineno? (':'+e.lineno):'');
});

// ===== é…ç½® =====
const CFG = {
  W:800, H:800,
  center:{x:400, y:400},
  perSide:13, track:52,
  ringMargin: 280,
  cellR: 14,
  runwayLen: 6,
  colors: ['#ff4d6d', '#ffd166', '#6ab0ff', '#18c0a6'],
  players:[{name:'çº¢æ–¹'},{name:'é»„æ–¹'},{name:'è“æ–¹'},{name:'ç»¿æ–¹'}]
};

const cvs=document.getElementById('board');
const ctx=cvs.getContext('2d');

function rgba(hex,a){ // '#rrggbb' -> 'rgba(...)'
  if(hex && hex[0]==='#' && hex.length>=7){
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
  }
  return hex;
}


// ===== æ„å»ºå¤–åœˆï¼šç©ºå¿ƒåŠ å·ï¼ˆæ­£æ–¹å½¢å¤–è½®å»“ï¼‰ï¼Œå¤–è¾¹å„7æ ¼ã€è¿æ¥å„3æ ¼ã€è§’ç‚¹æ— ç‚¹ï¼Œæ€»52 =====
function buildRing(){
  const cx=CFG.center.x, cy=CFG.center.y;
  const outer=340, arm=160; // æ­£æ–¹å¤–è½®å»“ + è‡‚åŠåšåº¦
  const L=cx-outer, R=cx+outer, T=cy-outer, B=cy+outer;
  const ixL=cx-arm, ixR=cx+arm, iyT=cy-arm, iyB=cy+arm;

  const segs=[
    {a:{x:ixL,y:T},   b:{x:ixR,y:T},    uniq:7},
    {a:{x:ixR,y:T},   b:{x:ixR,y:iyT},  uniq:3},
    {a:{x:ixR,y:iyT}, b:{x:R,  y:iyT},  uniq:3},
    {a:{x:R,  y:iyT}, b:{x:R,  y:iyB},  uniq:7},
    {a:{x:R,  y:iyB}, b:{x:ixR,y:iyB},  uniq:3},
    {a:{x:ixR,y:iyB}, b:{x:ixR,y:B},    uniq:3},
    {a:{x:ixR,y:B},   b:{x:ixL,y:B},    uniq:7},
    {a:{x:ixL,y:B},   b:{x:ixL,y:iyB},  uniq:3},
    {a:{x:ixL,y:iyB}, b:{x:L,  y:iyB},  uniq:3},
    {a:{x:L,  y:iyB}, b:{x:L,  y:iyT},  uniq:7},
    {a:{x:L,  y:iyT}, b:{x:ixL,y:iyT},  uniq:3},
    {a:{x:ixL,y:iyT}, b:{x:ixL,y:T},    uniq:3}
  ];

  const pts=[];
  for(const s of segs){
    const total = s.uniq + 2; // ä¸å«é¦–å°¾
    for(let i=0;i<total;i++){
      const t = i/(total-1);
      if(i===0 || i===total-1) continue;
      pts.push({ 
        x: s.a.x + (s.b.x - s.a.x) * t,
        y: s.a.y + (s.b.y - s.a.y) * t
      });
    }
  }
  return pts;
}

// ===== æ—‹è½¬å¤–åœˆç´¢å¼•ï¼ˆæ­£è´Ÿ = é¡º/é€†æ—¶é’ˆï¼‰ =====
function rotateRing(arr, k){
  const n = arr.length;
  const s = ((k % n) + n) % n;
  return arr.slice(s).concat(arr.slice(0, s));
}

let RING=buildRing();
RING = rotateRing(RING, -3);


// é—¨å£ä¸èµ·ç‚¹
const gates=[6,19,32,45];
const starts=gates.map(g=>(g+3)%CFG.track);

// è·‘é“ï¼ˆæœä¸­å¿ƒ 6 æ ¼ï¼‰

function buildRunway(p){
  const a=[]; 
  const gp=RING[gates[p]]; 
  const cx=CFG.center.x, cy=CFG.center.y;
  const vx=cx-gp.x, vy=cy-gp.y, L=Math.hypot(vx,vy)||1, ux=vx/L, uy=vy/L;
  const gap = CFG.cellR * 3.2 + 10; // +10px é—´è·åŠ å¤§       // åœ†å¿ƒé—´è·ï¼ˆç¨€ç–ï¼‰
  const start = CFG.cellR * 2.4 + 12; // ä¸é—¨å£åœ†çš„é—´éš”ï¼ˆæ›´å¤§ï¼‰
  for(let i=0;i<CFG.runwayLen;i++){
    const d = start + gap * i;
    a.push({x:gp.x + ux*d, y:gp.y + uy*d});
  }
  return a;
}
const RUNWAY=[0,1,2,3].map(buildRunway);


// è¿ç»­äº¤æ›¿ + é—¨å£åŒè‰²æ ¡å‡†
function ringColorAt(i){
  // åŸºäºåŸæœ‰æ ¡å‡†ï¼šK=2ï¼ˆé—¨å£åŒè‰²æ ¡å‡†ï¼‰ï¼ŒSHIFT=1ï¼ˆæ•´ä½“é¢œè‰²é€†æ—¶é’ˆä¸€æ ¼ï¼‰
  const K=2, SHIFT=1;
  const idx = (((i - K - SHIFT) % 4) + 4) % 4;
  // ä»…å¯¹æ ¼å­è¿›è¡Œé¢œè‰²æ˜ å°„ï¼šçº¢->é»„, é»„->è“, è“->ç»¿, ç»¿->çº¢
  const map = [1,2,3,0]; // 0:red->1:yellow, 1:yellow->2:blue, 2:blue->3:green, 3:green->0:red
  return CFG.colors[ map[idx] ];
}

// ===== å¤§æœ¬è¥æ”¾åœ¨å››è§’ï¼ˆé¡ºæ—¶é’ˆï¼‰ï¼šå³ä¸Šã€å³ä¸‹ã€å·¦ä¸‹ã€å·¦ä¸Š =====
function baseSlot(p,slot){
  const c=CFG.center, off=300, g=39;
  const centers=[
    {x:c.x+off, y:c.y-off}, // çº¢ å³ä¸Š
    {x:c.x+off, y:c.y+off}, // é»„ å³ä¸‹
    {x:c.x-off, y:c.y+off}, // è“ å·¦ä¸‹
    {x:c.x-off, y:c.y-off}, // ç»¿ å·¦ä¸Š
  ];
  const cc=centers[p];
  const dx=(slot%2===0? -g : g);
  const dy=(Math.floor(slot/2)===0? -g : g);
  return {x:cc.x+dx, y:cc.y+dy};
}

// èµ·é£åŒºï¼šæ”¾åœ¨â€œå¤–åœˆèµ·ç‚¹â€æ–¹å‘ï¼Œæ²¿å¤–æ³•çº¿å‘å¤–åç§»
function launchPadPos(p){
  const rp=RING[starts[p]];
  const cx=CFG.center.x, cy=CFG.center.y;
  const vx=rp.x-cx, vy=rp.y-cy;
  const L=Math.hypot(vx,vy)||1, ux=vx/L, uy=vy/L;
  const out=34; // åŸºç¡€è·ç¦»
  let pos={x:rp.x+ux*out, y:rp.y+uy*out};
  const shift=30; // æœå¤§æœ¬è¥æ–¹å‘å¹³ç§»
  if(p===0) pos.x += shift;      // çº¢ - å³
  if(p===1) pos.y += shift;      // é»„ - ä¸‹
  if(p===2) pos.x -= shift;      // è“ - å·¦
  if(p===3) pos.y -= shift;      // ç»¿ - ä¸Š
  return pos;
}

// ===== çŠ¶æ€ä¸æ£‹å­ =====
const S={cur:0,dice:-1,canRoll:true,canEnd:false,mustPick:false,tokens:[]};

function createTokens(){
  S.tokens=[];
  for(let p=0;p<4;p++){
    for(let t=0;t<4;t++){
      const b=baseSlot(p,t);
      S.tokens.push({player:p,id:t,pos:{type:'base'},x:b.x,y:b.y,done:false});
    }
  }
}

function placeToBase(t){ const b=baseSlot(t.player,t.id); t.pos={type:'base'}; t.x=b.x; t.y=b.y; t.done=false; }
function placeToPad(t){ const lp=launchPadPos(t.player); t.pos={type:'pad'}; t.x=lp.x; t.y=lp.y; }
function placeToRing(t,idx){ t.pos={type:'ring',idx:((idx%CFG.track)+CFG.track)%CFG.track}; const pt=RING[t.pos.idx]; t.x=pt.x; t.y=pt.y; }
function placeToRun(t,st){ t.pos={type:'runway',run:st}; const pt=RUNWAY[t.player][st-1]; t.x=pt.x; t.y=pt.y; }
function placeToHome(t){ t.pos={type:'home'}; const c=CFG.center, off=220, dx=[0,1,0,-1][t.player]*off, dy=[-1,0,1,0][t.player]*off; t.x=c.x+dx; t.y=c.y+dy; t.done=true; }

function canMove(t,steps){
  if(t.done||steps<=0) return false;
  const gate=gates[t.player];
  if(t.pos.type==='base') return steps===6;
  if(t.pos.type==='pad') return true;
  if(t.pos.type==='ring'){
    const cur=t.pos.idx, dist=(gate-cur+CFG.track)%CFG.track;
    if(steps>dist){ const remain=steps-dist-1; return remain>=0 && remain<=CFG.runwayLen-1; }
    return true;
  }
  if(t.pos.type==='runway') return t.pos.run + steps <= CFG.runwayLen;
  return false;
}

function eatIfAny(m){
  if(m.pos.type!=='ring') return;
  S.tokens.forEach(o=>{
    if(o===m) return; if(o.pos.type!=='ring') return;
    if(o.pos.idx===m.pos.idx && o.player!==m.player){ placeToBase(o); setMsg('ğŸ‘Š åƒå­ï¼å¯¹æ‰‹å›åŸºåœ°ã€‚'); }
  });
}

function sameColorJump(t){
  if(t.pos.type!=='ring') return;
  if(ringColorAt(t.pos.idx)===CFG.colors[t.player]){
    placeToRing(t,(t.pos.idx+4)%CFG.track);
    eatIfAny(t);
    setMsg('ğŸ¨ åŒè‰²è·³ +4');
  }
}

function stepAlongRing(t,steps){
  const gate=gates[t.player], cur=t.pos.idx, dist=(gate-cur+CFG.track)%CFG.track;
  if(steps>dist){ const remain=steps-dist-1; placeToRun(t,1+remain); }
  else{ placeToRing(t,(cur+steps)%CFG.track); eatIfAny(t); sameColorJump(t); }
}

function tryMove(t){
  const k=S.dice; if(!canMove(t,k)) return;
  const start=starts[t.player];
  if(t.pos.type==='base' && k===6){ placeToPad(t); }
  else if(t.pos.type==='pad'){ let r=k-1; placeToRing(t,start); eatIfAny(t); sameColorJump(t); if(r>0) stepAlongRing(t,r); }
  else if(t.pos.type==='ring'){ stepAlongRing(t,k); }
  else if(t.pos.type==='runway'){ t.pos.run+=k; if(t.pos.run===CFG.runwayLen) placeToHome(t); else placeToRun(t,t.pos.run); }
  const win = S.tokens.filter(x=>x.player===t.player && x.done).length===4;
  if(win){ setMsg('ğŸ‰ èƒœåˆ©ï¼'); freeze(); return; }
  if(k===6){ setMsg('æ·å‡º 6ï¼Œå¯å†æ·ã€‚'); S.canRoll=true; S.mustPick=false; S.canEnd=false; updateUI(); return; }
  endTurn();
}

// ===== æ¸²æŸ“ =====
function fillC(x,y,r,f){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=f; ctx.fill(); }
function strokeC(x,y,r,s){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.strokeStyle=s; ctx.lineWidth=2; ctx.stroke(); }

function drawBoard(){
  ctx.clearRect(0,0,CFG.W,CFG.H);
  // å¤§æœ¬è¥ï¼šä»¥ baseSlot çš„å››ä¸ªä¸­å¿ƒä¸ºåŸºå‡†ç»˜åˆ¶å¤§åº•åœˆï¼ˆç›´å¾„â‰ˆ3æ ¼ -> åŠå¾„â‰ˆ60ï¼‰
  (function(){
    const c=CFG.center, off=300, BASE_R=100;
    const centers=[
      {x:c.x+off, y:c.y-off}, // çº¢ å³ä¸Š
      {x:c.x+off, y:c.y+off}, // é»„ å³ä¸‹
      {x:c.x-off, y:c.y+off}, // è“ å·¦ä¸‹
      {x:c.x-off, y:c.y-off}, // ç»¿ å·¦ä¸Š
    ];
    for(let pl=0; pl<4; pl++){
      const cc=centers[pl];
      const side = BASE_R*2;
      ctx.fillStyle = rgba(CFG.colors[pl], 0.10);
      ctx.fillRect(cc.x - BASE_R, cc.y - BASE_R, side, side);
      ctx.strokeStyle = CFG.colors[pl];
      ctx.lineWidth = 2;
      ctx.strokeRect(cc.x - BASE_R, cc.y - BASE_R, side, side);
    }
  })();

  for(let i=0;i<CFG.track;i++){ const p=RING[i]; fillC(p.x,p.y,CFG.cellR+6, rgba(ringColorAt(i),0.66)); strokeC(p.x,p.y,CFG.cellR+6,'#2d356f'); }
  for(let pl=0; pl<4; pl++){
    const gp=RING[gates[pl]]; strokeC(gp.x,gp.y, CFG.cellR+10, CFG.colors[pl]); // é—¨å£
    const sp=RING[starts[pl]]; fillC(sp.x,sp.y, CFG.cellR+10, rgba(CFG.colors[pl],0.33)); // èµ·ç‚¹æ ‡è®°
    RUNWAY[pl].slice(0, CFG.runwayLen-1).forEach(pt=> { fillC(pt.x,pt.y, CFG.cellR+6, rgba(CFG.colors[pl],0.22)); strokeC(pt.x,pt.y, CFG.cellR+6, CFG.colors[pl]); }); // è·‘é“ï¼ˆä¸ç”»æœ€åä¸€æ ¼ï¼‰
    const lp=launchPadPos(pl); fillC(lp.x,lp.y, CFG.cellR+8, rgba(CFG.colors[pl],0.33)); strokeC(lp.x,lp.y, CFG.cellR+8, CFG.colors[pl]); // èµ·é£åŒº
  }

  // å¤§æœ¬è¥æ£‹å­æ§½ä½æŒ‡ç¤ºåœˆï¼šåœ¨æ¯ä¸ª baseSlot ä½ç½®ç”»ä¸€ä¸ªç¨å¤§çš„æè¾¹åœˆ
  for(let pl=0; pl<4; pl++){
    for(let s=0; s<4; s++){
      const pt = baseSlot(pl, s);
      strokeC(pt.x, pt.y, CFG.cellR * 2.4, rgba(CFG.colors[pl], 0.35));
    }
  }

  S.tokens.forEach(t=>{ fillC(t.x,t.y,CFG.cellR,CFG.colors[t.player]); strokeC(t.x,t.y,CFG.cellR,'#fff'); });
}

function render(){ drawBoard(); requestAnimationFrame(render); }

// ===== äº¤äº’ & UI =====
cvs.addEventListener('click',(ev)=>{
  if(!S.mustPick) return;
  const r=cvs.getBoundingClientRect(), mx=ev.clientX-r.left, my=ev.clientY-r.top;
  let pick=null,best=1e9;
  S.tokens.forEach(t=>{
    if(t.player!==S.cur) return;
    if(!canMove(t,S.dice)) return;
    const d=Math.hypot(t.x-mx,t.y-my); if(d<CFG.cellR+12 && d<best){ best=d; pick=t; }
  });
  if(pick) tryMove(pick);
});

function updateUI(){
  rollBtn.disabled=!S.canRoll; endBtn.disabled=!S.canEnd;
  turnTag.textContent=`å½“å‰ï¼š${CFG.players[S.cur].name}`; turnTag.className=`badge p${S.cur}`;
  diceTag.textContent=`éª°å­ï¼š${S.dice<0?'-':S.dice}`;
}
function setMsg(t){ msg.textContent=t; 
  // åŒæ­¥åˆ°è¡ŒåŠ¨æ—¥å¿—
  try{
    const ul = document.getElementById('actionLogList');
    if(ul){
      const li = document.createElement('li');
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      li.innerHTML = `<span class="time">[${hh}:${mm}:${ss}]</span>` + t;
      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }
  }catch(e){}
}
function endTurn(){ S.cur=(S.cur+1)%4; S.canRoll=true; S.canEnd=false; S.mustPick=false; S.dice=-1; updateUI(); }
function freeze(){ S.canRoll=false; S.canEnd=false; S.mustPick=false; updateUI(); }

rollBtn.addEventListener('click',()=>{
  if(!S.canRoll) return;
  S.dice = Math.floor(Math.random()*6)+1;
  const cur = S.cur;
  const has = S.tokens.some(t=> t.player===cur && canMove(t, S.dice));
  if(!has){
    S.canRoll=false; S.mustPick=false; S.canEnd=false; updateUI();
    setMsg(`${CFG.players[cur].name} æ·å‡º ${S.dice}ï¼Œæ— æ£‹å¯èµ°ï¼Œè‡ªåŠ¨ç»“æŸå›åˆã€‚`);
    setTimeout(()=>{ endTurn(); }, 800);
    return;
  }
  const isAI = (S.ai && S.ai[cur]);
  if(isAI){
    // AI è‡ªåŠ¨è¡ŒåŠ¨ï¼šç®€å•ç­–ç•¥ = é€‰æ‹©ç¬¬ä¸€ä¸ªå¯èµ°çš„æ£‹
    S.canRoll=false; S.mustPick=false; S.canEnd=false; updateUI();
    setMsg(`${CFG.players[cur].name}ï¼ˆAIï¼‰æ·å‡º ${S.dice}ï¼Œè‡ªåŠ¨è¡ŒåŠ¨ä¸­â€¦`);
    const cand = S.tokens.find(t=> t.player===cur && canMove(t, S.dice));
    setTimeout(()=>{ tryMove(cand); }, 400);
  }else{
    // äººç±»ï¼šç­‰å¾…ç‚¹å‡»æ£‹å­
    S.canRoll=false; S.mustPick=true; S.canEnd=false; updateUI();
    setMsg(`${CFG.players[cur].name} æ·å‡º ${S.dice}ï¼Œè¯·é€‰æ‹©å¯ç§»åŠ¨çš„æ£‹å­ã€‚`);
  }
});
endBtn.addEventListener('click',()=>{ if(!S.canEnd) return; endTurn(); setMsg(`è½®åˆ° ${CFG.players[S.cur].name}ã€‚`); });

// ===== å¯åŠ¨ =====
createTokens(); updateUI(); render();
</script>

<script>
// === å…¬å…±ç»ˆç‚¹ï¼ˆå…±äº«ä¸­å¿ƒå•æ ¼ï¼‰ ===
const GOAL = { x: CFG.center.x, y: CFG.center.y };

// è¦†ç›– placeToHomeï¼šè½åœ¨å…¬å…±ç»ˆç‚¹
const __orig_placeToHome = placeToHome;
placeToHome = function(t){
  t.pos = { type:'home' };
  t.x = GOAL.x; t.y = GOAL.y;
  t.done = true;
};

// è¦†ç›– drawBoardï¼šæŠŠå…¬å…±ç»ˆç‚¹ç”»åœ¨æœ€ä¸Šå±‚
const __drawBoard_old = drawBoard;
drawBoard = function(){
  __drawBoard_old();
  // é‡‘è¾¹ç™½å¿ƒå…¬å…±ç»ˆç‚¹ï¼ˆé«˜å¯¹æ¯”ï¼‰
  fillC(GOAL.x, GOAL.y, CFG.cellR + 18, '#ffd166');
  strokeC(GOAL.x, GOAL.y, CFG.cellR + 18, '#ffd166');
  fillC(GOAL.x, GOAL.y, CFG.cellR + 10, '#ffffff');
  strokeC(GOAL.x, GOAL.y, CFG.cellR + 10, '#000000');
};
</script>


<script>
// === Start Screen control ===
(function(){
  const scr = document.getElementById('startScreen');
  const startBtn = document.getElementById('startBtn');
  function begin(){
    if(!scr) return;
    // è¯»å– AI é…ç½®
    try{
      S.ai=[
        document.getElementById('aiRed').value==='ai',
        document.getElementById('aiYellow').value==='ai',
        document.getElementById('aiBlue').value==='ai',
        document.getElementById('aiGreen').value==='ai',
      ];
    // å†™æ­»ä¸€æ¬¡ï¼Œä¸åšè½®è¯¢ï¼šå°†å¼€å±€é€‰æ‹©é™æ€æ˜¾ç¤ºåœ¨å·¦ä¾§çŠ¶æ€é¢æ¿
    try{
      for(let i=0;i<4;i++){
        const el = document.getElementById('aiTag'+i);
        if(el) el.textContent = S.ai[i] ? 'AI' : 'äººç±»';
      }
    }catch(e){}
    }catch(e){ S.ai=[false,false,false,false]; }
    scr.style.display='none'; if(window.__renderAITags) __renderAITags(); if(window.__placePanels) __placePanels(); try{ setMsg('æ¸¸æˆå¼€å§‹'); }catch(e){}
    if(window.__renderAITags) __renderAITags(); if(window.__placePanels) __placePanels();
    // å…è®¸æ·éª°ï¼Œå¹¶æç¤ºå½“å‰ç©å®¶
    try{
      S.canRoll = true; S.mustPick = false; S.canEnd = false; updateUI();
      const who = CFG.players[S.cur].name;
      setMsg(`${who} å¼€å§‹ä½ çš„å›åˆï¼Œç‚¹å‡»æ·éª°ã€‚`);
    }catch(e){ /* å¿½ç•¥ */ }
  }
  startBtn.addEventListener('click', begin);
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key.toLowerCase()==='s'){ begin(); }
  });
  // åˆå§‹ç¦æ­¢æ·éª°ï¼Œç›´åˆ°å¼€å§‹
  try{ S.canRoll=false; updateUI(); S.ai=[false,false,false,false]; }catch(e){}
})();
</script>


<script>
(function(){
  const btn = document.getElementById('rollBtn');
  const cvs = document.getElementById('board');
  if(!btn || !cvs) return;
  function place(){
  const rect = cvs.getBoundingClientRect();
  const margin = 20; // ä¸æ£‹ç›˜å³ä¾§çš„é—´è·
  // è¯»å–æŒ‰é’®å°ºå¯¸ï¼ˆåŒ…å«scaleæ•ˆæœï¼‰
  const bRect = btn.getBoundingClientRect();
  const bw = bRect.width, bh = bRect.height;
  // è®©æŒ‰é’®ç´§è´´æ£‹ç›˜å³ä¾§ï¼Œä¸”åº•è¾¹ä¸æ£‹ç›˜åº•è¾¹é½å¹³
  const xPage = rect.right + margin;
  const yPage = rect.bottom - bh + 6; // é˜´å½±/æ”¾å¤§è¡¥å¿ï¼Œç¡®ä¿çœŸæ­£åº•å¯¹é½
  btn.style.left = Math.round(xPage) + "px";
  btn.style.top  = Math.round(yPage) + "px";
}
  window.addEventListener('resize', place);
  window.addEventListener('scroll', place, {passive:true});
  setTimeout(place, 0);
  window.addEventListener('load', place);
  const scr = document.getElementById('startScreen');
  if(scr){
    const obs = new MutationObserver(place);
    obs.observe(scr, {attributes:true, attributeFilter:['style','class']});
  }
})();
</script>


<script>
// === Place AI status panel near board (top-right outside) and keep updated ===
(function(){
  const panel = document.getElementById('aiStatus');
  const cvs = document.getElementById('board');
  if(!panel || !cvs) return;
  function placeAI(){
    const rect = cvs.getBoundingClientRect();
    const margin = 20;
    const x = rect.right + margin;
    const y = rect.top;
    panel.style.left = Math.round(x) + "px";
    panel.style.top  = Math.round(y) + "px";
  }
  window.addEventListener('resize', placeAI);
  window.addEventListener('scroll', placeAI, {passive:true});
  window.addEventListener('load', placeAI);
  setTimeout(placeAI, 0);

  function renderAIStatus(){
    if(!(window.S)) return; if(!Array.isArray(S.ai)) { S.ai=[false,false,false,false]; }
    panel.style.display='block';
    const names = S.ai.map(v=> v ? 'AI' : 'äººç±»');
    for(let i=0;i<4;i++){
      const el = document.getElementById('aiTag'+i);
      if(el) el.textContent = names[i];
    }
  }
  // ç®€å•è½®è¯¢åˆ·æ–°ï¼šå¯åŠ¨åä¸æ¯å›åˆç»“æŸ/å¼€å§‹éƒ½èƒ½åˆ·æ–°
  setInterval(renderAIStatus, 300);
})();

// === Auto-roll for AI turns ===
(function(){
  const rollBtn = document.getElementById('rollBtn');
  function tick(){
    try{
      if(S && S.ai && S.ai[S.cur] && S.canRoll){
        // å½“å‰ä¸ºAIä¸”å¯æ·éª°ï¼šè‡ªåŠ¨ç‚¹æ·éª°
        rollBtn.click();
      }
    }catch(e){/* ignore */}
  }
  setInterval(tick, 300);
})();
</script>


<style>
#aiStatus{
  position:fixed; z-index:9998;
  background:rgba(17,24,39,.85); color:#e5e7eb;
  border:1px solid rgba(255,255,255,.08); border-radius:10px;
  padding:10px 12px; backdrop-filter: blur(4px);
  min-width: 160px;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  font:13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
#aiStatus .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:2px 0; }
#aiStatus .who{ display:flex; align-items:center; gap:8px; }
#aiStatus .dot{ width:10px; height:10px; border-radius:50%; }
#aiStatus .p0{ background:#d63b3b } /* çº¢ */
#aiStatus .p1{ background:#f6b10a } /* é»„ */
#aiStatus .p2{ background:#4d77c9 } /* è“ */
#aiStatus .p3{ background:#5aa654 } /* ç»¿ */
#aiStatus .tag{ opacity:.9; }
#aiStatus .cur{ font-weight:700; color:#fff; }

#actionLog{
  position:fixed; z-index:9998;
  width:260px; max-width:32vw;
  background:rgba(17,24,39,.85); color:#e5e7eb;
  border:1px solid rgba(255,255,255,.08); border-radius:10px;
  padding:10px 12px; backdrop-filter: blur(4px);
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  font:12px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
#actionLog .title{ font-weight:700; font-size:13px; margin-bottom:6px; color:#fff; }
#actionLog ul{ list-style:none; margin:0; padding:0; max-height:60vh; overflow:auto; }
#actionLog li{ opacity:.92; margin:2px 0; }
#actionLog .time{ opacity:.6; margin-right:6px; font-size:11px; }
</style>
<div id="actionLog" style="display:none">
  <div class="title">è¡ŒåŠ¨æ—¥å¿—</div>
  <ul id="actionLogList"></ul>
</div>


<script>
(function(){
  const panel = document.getElementById('aiStatus');
  const log   = document.getElementById('actionLog');
  const cvs   = document.getElementById('board');
  if(!cvs) return;
  function place(){
    const rect = cvs.getBoundingClientRect();
    const margin = 20;
    if(panel){
      panel.style.display='block';
      // å·¦ä¾§ä¸­é—´ï¼šå·¦å¤–ä¾§ï¼Œå‚ç›´å±…ä¸­
      const pRect = panel.getBoundingClientRect();
      panel.style.left = Math.round(rect.left - margin - pRect.width) + 'px';
      panel.style.top  = Math.round(rect.top + rect.height/2 - pRect.height/2) + 'px';
    }
    if(log){
      log.style.display='block';
      // å³ä¾§ä¸­é—´ï¼šå³å¤–ä¾§ï¼Œå‚ç›´å±…ä¸­
      const lRect = log.getBoundingClientRect();
      log.style.left = Math.round(rect.right + margin) + 'px';
      log.style.top  = Math.round( rect.top + rect.height/2 - lRect.height/2 - 40 ) + 'px';
    }
  }
  window.addEventListener('resize', place);
  window.addEventListener('scroll', place, {passive:true});
  window.addEventListener('load', place);
  setTimeout(place, 0);
  // Also re-place when start screen hides
  const scr = document.getElementById('startScreen');
  if(scr){
    const obs = new MutationObserver(place);
    obs.observe(scr, {attributes:true, attributeFilter:['style','class']});
  }
  // AIæ ‡ç­¾åˆ·æ–°ï¼šæ ‡è®°å½“å‰å›åˆ
  function renderAI(){
    if(!(window.S)) return; if(!Array.isArray(S.ai)) { S.ai=[false,false,false,false]; }
    for(let i=0;i<4;i++){
      const el = document.getElementById('aiTag'+i);
      if(!el) continue;
      el.textContent = S.ai[i] ? 'AI' : 'äººç±»';
      el.classList.toggle('cur', i===S.cur);
    }
  }
  setInterval(()=>{ place(); renderAI(); }, 300);
})();
</script>


<script>
// === Panels placement + AI tag render ===
(function(){
  const panel = document.getElementById('aiStatus');
  const log   = document.getElementById('actionLog');
  const cvs   = document.getElementById('board');
  function placePanels(){
    if(!cvs) return;
    const rect = cvs.getBoundingClientRect();
    const margin = 20;
    if(panel){
      panel.style.display='block';
      const pRect = panel.getBoundingClientRect();
      panel.style.left = Math.round(rect.left - margin - pRect.width) + 'px';
      panel.style.top  = Math.round(rect.top + rect.height/2 - pRect.height/2) + 'px';
    }
    if(log){
      log.style.display='block';
      const lRect = log.getBoundingClientRect();
      log.style.left = Math.round(rect.right + margin) + 'px';
      log.style.top  = Math.round( rect.top + rect.height/2 - lRect.height/2 - 40 ) + 'px';
    }
  }
  function renderAITags(){
    try{
      if(!(window.S)) return; if(!Array.isArray(S.ai)) { S.ai=[false,false,false,false]; }
      for(let i=0;i<4;i++){
        const el = document.getElementById('aiTag'+i);
        if(!el) continue;
        el.textContent = S.ai[i] ? 'AI' : 'äººç±»';
        el.classList.toggle('cur', i===S.cur);
      }
    }catch(e){}
  }
  window.addEventListener('resize', placePanels);
  window.addEventListener('scroll', placePanels, {passive:true});
  window.addEventListener('load', ()=>{ placePanels(); renderAITags(); });
  setInterval(()=>{ placePanels(); renderAITags(); }, 500);
  // Expose for other code to call
  window.__placePanels = placePanels;
  window.__renderAITags = renderAITags;
})();
</script>


<script>/*__ENDTURN_HOOKED__*/
(function(){
  const _endTurn = window.endTurn;
  if(typeof _endTurn==='function'){
    window.endTurn = function(){
      const r = _endTurn.apply(this, arguments);
      if(window.__renderAITags) __renderAITags();
      if(window.__placePanels) __placePanels();
      return r;
    }
  }
})();</script>


<script>
// å¼ºåˆ¶åˆ·æ–°å·¦ä¾§â€œAI/äººç±»â€çŠ¶æ€ï¼šå®šæ—¶+å¼€å±€åŒä¿é™©
(function(){
  function refreshAIStatus(){
    try{
      if(!window.S) return;
      if(!Array.isArray(S.ai)) S.ai=[false,false,false,false];
      for(let i=0;i<4;i++){
        var tag = document.getElementById('aiTag'+i);
        if(tag) tag.textContent = S.ai[i] ? 'AI' : 'äººç±»';
      }
    }catch(e){ /* ignore */ }
  }
  window.addEventListener('load', refreshAIStatus);
  setInterval(refreshAIStatus, 300);
})();
</script>


<script>
function sameSpot(a, pos){
  // pos may be object {x,y} or logical position; try both
  try{
    if(a.pos && pos && a.pos.x===pos.x && a.pos.y===pos.y) return true;
  }catch(e){}
  try{
    if(a.x!==undefined && a.y!==undefined && pos && pos.x===a.x && pos.y===a.y) return true;
  }catch(e){}
  return false;
}
</script>


<script>
function occupiedBySelfOnRing(player, idx){
  try{
    return S.tokens.some(o => o.player===player && o.pos && o.pos.type==='ring' && o.pos.idx===((idx%CFG.track)+CFG.track)%CFG.track);
  }catch(e){ return false; }
}
function occupiedBySelfOnRunway(player, run){
  try{
    return S.tokens.some(o => o.player===player && o.pos && o.pos.type==='runway' && o.pos.run===run);
  }catch(e){ return false; }
}
</script>

</body>
</html>
